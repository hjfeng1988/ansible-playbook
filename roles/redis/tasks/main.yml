---
# tasks file for redis

- name: copy to /usr/local/src/redis-4.0.9-linux.tar.gz
  copy:
    src: redis-4.0.9-linux.tar.gz
    dest: /usr/local/src/redis-4.0.9-linux.tar.gz

- name: unarchive redis to /usr/local/redis
  shell:
    cmd: |
      cd /usr/local/src
      tar zxf redis-4.0.9-linux.tar.gz
      mv redis /usr/local/redis
  args:
    creates: /usr/local/redis  

- name: check if redis.log exists
  stat:
    path: /usr/local/redis/redis.log
  register: redis_server_rc1

- name: modify redis.conf bind
  replace:
    path: /usr/local/redis/redis.conf
    regexp: '^bind 127.0.0.1'
    replace: 'bind 0.0.0.0'
  when:
    - not redis_server_rc1.stat.exists

- name: modify redis.conf daemonize
  replace:
    path: /usr/local/redis/redis.conf
    regexp: 'daemonize no'
    replace: 'daemonize yes'
  when:
    - not redis_server_rc1.stat.exists

- name: modify redis.conf dir
  replace:
    path: /usr/local/redis/redis.conf
    regexp: 'dir ./'
    replace: 'dir /usr/local/redis'
  when:
    - not redis_server_rc1.stat.exists

- name: modify redis.conf logfile
  replace:
    path: /usr/local/redis/redis.conf
    regexp: 'logfile ""'
    replace: 'logfile "/usr/local/redis/redis.log"'
  when:
    - not redis_server_rc1.stat.exists

- name: add password to redis.conf
  blockinfile:
    path: /usr/local/redis/redis.conf
    block: |
      requirepass {{redis_pass}}
      masterauth {{redis_pass}}
  when:
    - not redis_server_rc1.stat.exists

- name: add slaveof to redis.conf 
  lineinfile:
    path: /usr/local/redis/redis.conf
    line: "slaveof {{groups['redis_master'][0]}} 6379"
  when:
    - inventory_hostname in groups ['redis_slave']
    - not redis_server_rc1.stat.exists

- import_tasks: optimize.yml

- name: check if redis-server process is running
  shell: ps -ef | grep -c redis-server
  register: redis_server_rc2

- name: start redis
  shell:
    cmd: /usr/local/redis/bin/redis-server /usr/local/redis/redis.conf
  when:
    - redis_server_rc2.stdout == '2'

- import_tasks: sentinel.yml
